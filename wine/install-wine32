#!/bin/bash

function abort
{
    REASON=$1

    if [ "$REASON" == "" ];
    then
        echo $REASON
    fi

    echo ""
    
    exit 1
}


if ! [ "$TERMUX_VERSION" == "" ];
then
    abort "This script isn't for Termux."
fi


sudo -v

if ! [ "$?" == "0" ];
then
    abort "You need to be root, or have sudo permissions."
fi




SETUP_DIR=$(realpath $(dirname $0))

DEFAULT_WINE_BRANCH="staging"
DEFAULT_WINE_VERSION="9.3"

WINE_BRANCH=$1
WINE_VERSION=$2


if [ "$WINE_BRANCH" == "" ];
then
    WINE_BRANCH=$DEFAULT_WINE_BRANCH
fi

if [ "$WINE_VERSION" == "" ];
then
    WINE_VERSION=$DEFAULT_WINE_VERSION
fi

DOWNLOAD_DIR=/var/tmp/wine-pkgs/$WINE_VERSION
UNINSTALLER="$HOME/wine32-uninstaller"


if [ -f "/opt/wine-${WINE_BRANCH}/bin/wine32" ];
then
    abort "Wine (32 bits) is already installed."
fi


if ! [ -f "/usr/lib/arm-linux-gnueabihf/libvkd3d.so.1" ];
then
    sudo "$SETUP_DIR/install-wine32-deps"    

    if ! [ "$?" == "0" ];
    then
        abort "Some required dependencies failed to install."
    fi
fi


$SETUP_DIR/download-wine $WINE_BRANCH $WINE_VERSION i386

if ! [ "$?" == "0" ];
then
    abort "Wine download failed."
fi


$DOWNLOAD_DIR/extract

if ! [ "$?" == "0" ];
then
    abort "The extraction failed."
fi


echo ""
echo "Installing Wine ..."
echo "-------------------"


if [ -d "/opt/wine-${WINE_BRANCH}/bin/wine" ];
then
    echo "Backing up the old installation first..."
    sudo mv /opt/wine-${WINE_BRANCH} /opt/wine-${WINE_BRANCH}-old

    if ! [ "$?" == "0" ];
    then
        abort "Something failed."
    fi

    echo "Done."
fi


sudo cp -r $DOWNLOAD_DIR/opt/wine-$WINE_BRANCH /opt/

sudo cp -r $DOWNLOAD_DIR/usr/share/doc/wine-${WINE_BRANCH} /usr/share/doc/

sudo cp -r $DOWNLOAD_DIR/usr/share/lintian/overrides \
           /wine-${WINE_BRANCH}-i386 /usr/share/lintian/overrides/

if ! [ "$?" == "0" ];
then
    abort "Failed copying files."
fi


echo "#!/bin/bash" > "$UNINSTALLER"
echo "" >> "$UNINSTALLER"
echo "if ! [ -f \"/opt/wine-${WINE_BRANCH}/bin/wine\" ];" >> "$UNINSTALLER"
echo "then" >> "$UNINSTALLER"
echo "    echo \"Didn't found Wine installed.\"" >> "$UNINSTALLER"
echo "    exit 1" >> "$UNINSTALLER"
echo "fi" >> "$UNINSTALLER"
echo "" >> "$UNINSTALLER"
echo "sudo rm -rf /opt/wine-${WINE_BRANCH}" >> "$UNINSTALLER"
echo "sudo rm -rf /usr/share/doc/wine-${WINE_BRANCH}" >> "$UNINSTALLER"

echo "sudo rm -rf /usr/share/lintian/overrides/wine-${WINE_BRANCH}-i386" \
     >> "$UNINSTALLER"

echo "" >> "$UNINSTALLER"

echo "Done." >> "$UNINSTALLER"
echo "" >> "$UNINSTALLER"


echo ""
echo "Finished."
echo "You can find also an uninstaller: ${UNINSTALLER}"
echo ""
